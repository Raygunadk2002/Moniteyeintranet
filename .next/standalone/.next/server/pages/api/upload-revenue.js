"use strict";(()=>{var e={};e.id=510,e.ids=[510],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6302:e=>{e.exports=require("xlsx")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6705:e=>{e.exports=import("formidable")},6555:e=>{e.exports=import("uuid")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},6186:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>d});var n=r(1802),a=r(7153),s=r(6249),i=r(7663),l=e([i]);i=(l.then?(await l)():l)[0];let u=(0,s.l)(i,"default"),c=(0,s.l)(i,"config"),d=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/upload-revenue",pathname:"/api/upload-revenue",bundlePath:"",filename:""},userland:i});o()}catch(e){o(e)}})},6137:(e,t,r)=>{r.d(t,{OQ:()=>s,pR:()=>i});let o=require("@supabase/supabase-js"),n="https://tfskdfkzhqiiamziggoB.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY,s=(0,o.createClient)(n,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmc2tkZmt6aHFpaWFtemlnZ29iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0Nzc3ODksImV4cCI6MjA2NTA1Mzc4OX0.wUR1GCbNEMrjcVRNG0l03Y0uXDgxd1y7wfAIGxSz5kA",{auth:{autoRefreshToken:!0,persistSession:!0},global:{fetch:(e,t={})=>fetch(e,{...t,signal:AbortSignal.timeout(3e4)})}}),i=(0,o.createClient)(n,a,{auth:{autoRefreshToken:!1,persistSession:!1},global:{fetch:(e,t={})=>fetch(e,{...t,signal:AbortSignal.timeout(45e3)})}})},7663:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>g,default:()=>m});var n=r(6705),a=r(6302),s=r(2048),i=r.n(s);r(5315);var l=r(6137),u=r(6555),c=e([n,u]);[n,u]=c.then?(await c)():c;let g={api:{bodyParser:!1}};function d(e){if(!e)return null;let t=e.toString().trim(),r=parseFloat(t);if(!isNaN(r)&&r>4e4&&r<5e4){let e=new Date(1900,0,1),t=r-1;r>59&&(t-=1);let o=new Date(e.getTime()+864e5*t);if(o.getFullYear()>=1990&&2100>=o.getFullYear())return o}let o=new Date(t);if(!isNaN(o.getTime())&&o.getFullYear()>1900)return o;for(let e of[/^(\d{4})-(\d{1,2})-(\d{1,2})$/i,/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/i,/^(\d{1,2})-(\d{1,2})-(\d{4})$/i,/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/i,/^(\w+)\s+(\d{1,2}),?\s+(\d{4})$/i,/^(\d{1,2})\s+(\w+)\s+(\d{4})$/i]){let r=t.match(e);if(r){let t,o,n;if(e.source.includes("\\w")){if(r[1]&&isNaN(parseInt(r[1]))){let e=["january","february","march","april","may","june","july","august","september","october","november","december"].findIndex(e=>e===r[1].toLowerCase());-1!==e&&(o=e+1,n=parseInt(r[2]),t=parseInt(r[3]))}else{let e=["january","february","march","april","may","june","july","august","september","october","november","december"].findIndex(e=>e===r[2].toLowerCase());-1!==e&&(n=parseInt(r[1]),o=e+1,t=parseInt(r[3]))}}else if(4===r[1].length)t=parseInt(r[1]),o=parseInt(r[2]),n=parseInt(r[3]);else{let e=parseInt(r[1]),a=parseInt(r[2]);t=parseInt(r[3]),e>12?(n=e,o=a):a>12?(o=e,n=a):(n=e,o=a)}if(t&&o&&n&&t>=1990&&t<=2100&&o>=1&&o<=12&&n>=1&&n<=31){let e=new Date(t,o-1,n);if(!isNaN(e.getTime())&&e.getFullYear()===t)return e}}}return null}async function m(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let r=(0,n.default)({maxFileSize:10485760,filter:({mimetype:e})=>!!(e&&(e.includes("spreadsheet")||e.includes("excel")||e.includes("vnd.ms-excel")||e.includes("vnd.openxmlformats-officedocument.spreadsheetml.sheet")))}),[o,s]=await r.parse(e),c=Array.isArray(s.file)?s.file[0]:s.file;if(!c)return t.status(400).json({error:"No file uploaded"});let m=a.readFile(c.filepath),g=m.SheetNames[0],h=m.Sheets[g],f=a.utils.sheet_to_json(h),p=a.utils.sheet_to_json(h,{header:1}),v=function(e,t){if(!t||t.length<2)return{success:!1,error:"File appears to be empty or has insufficient data",suggestions:["Ensure your Excel file has at least 2 rows of data (header + data row)"]};let r=-1,o=-1,n=[];if(e.length>0){let t=e[0];n=Object.keys(t),console.log("Available headers:",n);for(let e=0;e<n.length;e++)if(function(e){let t=e.toLowerCase();return!!(["invoice date","invoice_date","invoicedate","bill date","bill_date","billdate","date invoice","date_invoice","transaction date","transaction_date"].some(e=>t.includes(e))||t.includes("invoice")&&t.includes("date")||t.includes("bill")&&t.includes("date"))||["date","created","issued","fecha","datum","time","when","day"].some(e=>t.includes(e))}(n[e])){console.log(`Found date header: "${n[e]}" at column ${e}`),r=e;break}let a=!1;for(let e=0;e<n.length;e++){let t=n[e].toLowerCase();if(["gross (source)","gross(source)","gross source","gross_source","gross-source","grosssource"].some(e=>t.includes(e))){console.log(`Found gross source header: "${n[e]}" at column ${e}`),o=e,a=!0;break}}if(!a){for(let e=0;e<n.length;e++)if(function(e){let t=e.toLowerCase();return!!(["gross (source)","gross(source)","gross source","gross_source","gross-source","grosssource","gross amount","gross_amount","gross-amount"].some(e=>t.includes(e))||t.includes("gross")&&(t.includes("amount")||t.includes("value")||t.includes("total")))||["amount","value","total","sum","revenue","sales","income","price","cost","money","valor","monto","importe"].some(e=>t.includes(e))}(n[e])){console.log(`Found value header: "${n[e]}" at column ${e}`),o=e;break}}}if(-1===r||-1===o){let e=Math.max(...t.map(e=>e.length));for(let n=0;n<e;n++){let e=t.slice(1).map(e=>e[n]).filter(e=>null!=e);0!==e.length&&n!==r&&n!==o&&(-1===r&&function(e){let t=0,r=Math.min(10,e.length);for(let o=0;o<r;o++)e[o]&&d(e[o].toString())&&t++;return t/r>.5}(e)&&(r=n),-1===o&&n!==r&&function(e){let t=0,r=Math.min(10,e.length);for(let o=0;o<r;o++)e[o]&&!isNaN(parseFloat(e[o]))&&parseFloat(e[o])>0&&t++;return t/r>.7}(e)&&(o=n))}}if(1===n.length||r===o&&0===r){console.log("Using hardcoded column mapping: Column C (2) for dates, Column G (6) for amounts");let e=Math.max(...t.map(e=>e.length));if(e>=7&&(r=2,o=6,1===n.length)){n=[];for(let t=0;t<e;t++)n.push(`Column ${String.fromCharCode(65+t)}`);n[2]="Invoice Date (Column C)",n[6]="Gross Amount (Column G)"}}if(-1===r&&-1===o)return{success:!1,error:"Could not detect date or value columns",suggestions:['Ensure your Excel file has a column with invoice dates (e.g., "2025-01-15", "15/01/2025", "January 15, 2025")',"Ensure your Excel file has a column with invoice amounts/values",'Try using headers like "Date", "Invoice Date", "Amount", "Value", "Total"',"Make sure data starts from row 2 if row 1 contains headers"]};if(r===o)return{success:!1,error:"Date and amount columns cannot be the same. Both were detected in the same column.",suggestions:["Ensure your Excel file has separate columns for dates and amounts","Check that your date column only contains dates, not mixed date/amount data","Check that your amount column only contains numeric values","Your file should have at least 2 columns: one for dates, one for amounts"]};if(-1===r)return{success:!1,error:"Could not detect date column",suggestions:['Ensure you have a column with invoice dates in formats like "2025-01-15", "15/01/2025", "January 15, 2025"','Try adding a header like "Date", "Invoice Date", or "Transaction Date"',"Check that your date column contains recognizable date formats"]};if(-1===o)return{success:!1,error:"Could not detect value/amount column",suggestions:["Ensure you have a column with numeric values representing invoice amounts",'Try using headers like "Gross (Source)", "Gross Amount", "Amount", "Value", "Total", or "Revenue"','For best results, use "Gross (Source)" as your amount column header',"Check that your numeric column contains positive numbers without currency symbols"]};let a=`Detected invoice dates in column ${String.fromCharCode(65+r)} `;return n[r]&&(a+=`("${n[r]}") `),a+=`and invoice amounts in column ${String.fromCharCode(65+o)}`,n[o]&&(a+=` ("${n[o]}")`),{success:!0,dateColumn:r,valueColumn:o,startRow:1,headers:n,detectedFormat:a}}(f,p);if(!v.success)return t.status(400).json({error:v.error,suggestions:v.suggestions});let y=[],{dateColumn:w,valueColumn:b,startRow:S}=v;for(let e=S;e<p.length;e++){let t=p[e];if(t.length>Math.max(w,b)&&t[w]&&t[b]){let e=d(t[w]),r=parseFloat(t[b]);e&&!isNaN(r)&&r>0&&y.push({date:e,value:r})}}if(0===y.length)return t.status(400).json({error:"No valid invoice data found after processing. Please check the detected format matches your data.",detectedFormat:v.detectedFormat,suggestions:["Verify that your date column contains recognizable date formats (YYYY-MM-DD, DD/MM/YYYY, etc.)","Verify that your value column contains numeric amounts","Check for empty rows or cells in your data"]});let I=function(e){let t=new Map,r=new Date().toISOString();return e.forEach(e=>{let r=e.date.getFullYear(),o=e.date.getMonth()+1,n=`${r}-${o.toString().padStart(2,"0")}`,a=t.get(n)||0;t.set(n,a+e.value)}),Array.from(t.entries()).map(([e,t])=>{let[o,n]=e.split("-"),a=parseInt(o),s=parseInt(n);return{month:new Date(a,s-1,1).toLocaleDateString("en-US",{month:"long",year:"numeric"}),revenue:Math.round(100*t)/100,timestamp:r}}).sort((e,t)=>{let r=new Date(e.month+" 1"),o=new Date(t.month+" 1");return r.getTime()-o.getTime()})}(y),E=function(e){if(0===e.length)return{totalRevenue:0,revenueChange:"0%",revenueData:[]};let t=[...e].sort((e,t)=>{let r=new Date(e.month),o=new Date(t.month);return r.getTime()-o.getTime()}),r=t.reduce((e,t)=>e+t.revenue,0),o="0%";if(t.length>=2){let e=t[t.length-1].revenue,r=t[t.length-2].revenue;if(r>0){let t=(e-r)/r*100;o=`${t>=0?"+":""}${t.toFixed(1)}%`}}let n=t.map(e=>Math.round(e.revenue/1e3));return{totalRevenue:r,revenueChange:o,revenueData:n}}(I),$=(0,u.v4)(),_=y.sort((e,t)=>e.date.getTime()-t.date.getTime()),C=_[0].date.toISOString().split("T")[0],k=_[_.length-1].date.toISOString().split("T")[0],{error:F}=await l.pR.from("upload_batches").insert({id:$,filename:c.originalFilename||"unknown",total_invoices:y.length,total_amount:E.totalRevenue,months_generated:I.length,date_range_start:C,date_range_end:k});if(F){console.error("Error saving upload batch raw:",F),console.error("Error saving upload batch JSON:",JSON.stringify(F,null,2));let e=F.message||"Unknown Supabase error",t=F.code||"No code";throw console.error(`Supabase error: ${e} (code: ${t})`),Error(`Failed to save upload batch: ${e}`)}let N=y.map(e=>({invoice_date:e.date.toISOString().split("T")[0],amount:e.value,month_reference:`${e.date.getFullYear()}-${(e.date.getMonth()+1).toString().padStart(2,"0")}`,upload_batch_id:$})),{error:x}=await l.pR.from("invoices").insert(N);if(x){console.error("Error saving invoices raw:",x),console.error("Error saving invoices JSON:",JSON.stringify(x,null,2));let e=x.message||"Unknown Supabase error",t=x.code||"No code";throw console.error(`Supabase error: ${e} (code: ${t})`),Error(`Failed to save invoices: ${e}`)}let{error:A}=await l.pR.from("revenue_data").delete().gte("id",0);if(A){console.error("Error clearing revenue data raw:",A),console.error("Error clearing revenue data JSON:",JSON.stringify(A,null,2));let e=A.message||"Unknown Supabase error",t=A.code||"No code";throw console.error(`Supabase error: ${e} (code: ${t})`),Error(`Failed to clear existing revenue data: ${e}`)}let D=I.map(e=>{let t=e.month.split(" "),r=t[0],o=parseInt(t[1]),n=new Date(`${r} 1, ${o}`).getMonth()+1;return{month:e.month,revenue:e.revenue,year:o,month_number:n,invoice_count:y.filter(e=>{let t=e.date.getFullYear(),r=e.date.getMonth()+1;return t===o&&r===n}).length}}),{error:P}=await l.pR.from("revenue_data").insert(D);if(P){console.error("Error saving revenue data raw:",P),console.error("Error saving revenue data JSON:",JSON.stringify(P,null,2));let e=P.message||"Unknown Supabase error",t=P.code||"No code";throw console.error(`Supabase error: ${e} (code: ${t})`),Error(`Failed to save revenue data: ${e}`)}i().unlinkSync(c.filepath),t.status(200).json({message:"Invoice data processed and saved to database successfully!",recordsProcessed:y.length,monthsGenerated:I.length,totalRevenue:E.totalRevenue,dateRange:`${C} to ${k}`,detectedFormat:v.detectedFormat})}catch(r){console.error("Upload error:",r);let e=r instanceof Error?r.message:"An unknown error occurred";t.status(500).json({error:`Failed to process uploaded file. ${e}`})}}o()}catch(e){o(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=6186);module.exports=r})();